pipeline {
    agent any

    stages{
        stage("Clone repo"){
            steps{
                git branch: 'main', url: 'https://github.com/loreon-learning25/sample-app.git'
            }
        }

        stage("Build image"){
            steps{
                sh '''
                    cd /var/lib/jenkins/workspace/vote_app/vote
                    docker build -t voteapp:v1 .
                    docker tag voteapp:v1 danielbisiriyu/voteapp:latest
                '''
            }
        }

        stage("Docker login and push image to registry"){
            steps{
                withDockerRegistry(credentialsId: 'docker_hub_cred') {
                    sh 'docker push danielbisiriyu/voteapp:latest'
                }
                
            }
        }

        stage("Deploy image"){
            steps{
                sh 'docker run -d -p 5000:80 danielbisiriyu/voteapp:latest'
            }
        }
    }
}